# Copyright (c) 2026 LNXSeus. All Rights Reserved.
#
# This project is proprietary software. You are granted a license to use the software as-is.
# You may not copy, distribute, modify, reverse-engineer, or use this software
# or its source code in any way without the express written permission of the copyright holder.
#
# Created by Linus on 14.09.2025.
#

name: Build and Package

# This workflow runs on pushes and pull requests to the main branches.
on:
  push:
    branches: [ main, linux ]
  pull_request:
    branches: [ main, linux ]

jobs:
  # Job 1: Build, Test, and Package the Linux version
  build_linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install dependencies (Linux)
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake git libcurl4-openssl-dev libx11-dev libxext-dev libxrandr-dev libxcursor-dev libxfixes-dev libxi-dev libxss-dev libwayland-dev libdecor-0-dev libxkbcommon-dev libfreetype6-dev libharfbuzz-dev libasound2-dev libxtst-dev
          git clone https://github.com/libsdl-org/SDL.git -b main && cd SDL && cmake -B build && cmake --build build && sudo cmake --install build && cd ..
          git clone https://github.com/libsdl-org/SDL_image.git -b main && cd SDL_image && cmake -B build && cmake --build build && sudo cmake --install build && cd ..
          git clone https://github.com/libsdl-org/SDL_ttf.git -b main && cd SDL_ttf && cmake -B build && cmake --build build && sudo cmake --install build && cd ..
      - name: Configure CMake (Linux)
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release
      - name: Build Project
        run: cmake --build build --config Release
      - name: Run Executable Test (Linux)
        run: |
          echo "Running executable for 5 seconds..."
          timeout 5s ./build/Advancely --test-mode > output.txt 2>&1 || true
          echo "Executable run finished. Contents of output.txt:"
          cat output.txt
      - name: Upload Test Output (Linux)
        uses: actions/upload-artifact@v4
        with:
          name: test-output-v${{ env.PROJECT_VERSION }}-Linux
          path: output.txt
      - name: Package Linux Artifact
        shell: bash
        run: |
          mkdir release
          cp build/Advancely release/
          cp -r resources release/
      - name: Upload Linux Release Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Advancely-v${{ env.PROJECT_VERSION }}-Linux
          path: release/
